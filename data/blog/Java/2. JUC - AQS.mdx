---
title: Javaå¹¶å‘ç¼–ç¨‹ï¼šAQSï¼ˆAbstractQueuedSynchronizerï¼‰
date: '2025-04-26'
tags: ['java', 'juc', 'AQS']
draft: false
summary: AbstractQueuedSynchronizerï¼ˆAQSï¼‰æ˜¯Javaå¹¶å‘åŒ…ä¸­çš„ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä½äºjava.util.concurrent.locksåŒ…ä¸‹ï¼Œä¸ºæ„å»ºé”å’ŒåŒæ­¥å™¨æä¾›äº†ä¸€ä¸ªé€šç”¨æ¡†æ¶ã€‚å®ƒé€šè¿‡ç®¡ç†ä¸€ä¸ªå…±äº«çš„åŒæ­¥çŠ¶æ€ï¼ˆstateï¼‰å’Œä¸€ä¸ªå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œåè°ƒå¤šçº¿ç¨‹é—´çš„åŒæ­¥è¡Œä¸ºã€‚AQSçš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†é”çš„è·å–ã€é‡Šæ”¾å’Œçº¿ç¨‹æ’é˜Ÿç­‰å¤æ‚é€»è¾‘æŠ½è±¡å‡ºæ¥ï¼Œå¼€å‘è€…åªéœ€ç»§æ‰¿AQSå¹¶å®ç°å°‘é‡æ–¹æ³•ï¼ˆå¦‚`tryAcquire`å’Œ`tryRelease`ï¼‰ï¼Œå³å¯åˆ›å»ºè‡ªå®šä¹‰çš„åŒæ­¥å·¥å…·ã€‚
images: []
---
# AQS

***

## Javaå¹¶å‘ç¼–ç¨‹ï¼šAQSï¼ˆAbstractQueuedSynchronizerï¼‰

***

### 1. æ¦‚è¿°ä¸å®šä¹‰ ğŸŒŸ

**AbstractQueuedSynchronizerï¼ˆAQSï¼‰** æ˜¯Javaå¹¶å‘åŒ…ä¸­çš„ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä½äº`java.util.concurrent.locks`åŒ…ä¸‹ï¼Œä¸ºæ„å»ºé”å’ŒåŒæ­¥å™¨æä¾›äº†ä¸€ä¸ªé€šç”¨æ¡†æ¶ã€‚å®ƒé€šè¿‡ç®¡ç†ä¸€ä¸ªå…±äº«çš„åŒæ­¥çŠ¶æ€ï¼ˆstateï¼‰å’Œä¸€ä¸ªå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œåè°ƒå¤šçº¿ç¨‹é—´çš„åŒæ­¥è¡Œä¸ºã€‚AQSçš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†é”çš„è·å–ã€é‡Šæ”¾å’Œçº¿ç¨‹æ’é˜Ÿç­‰å¤æ‚é€»è¾‘æŠ½è±¡å‡ºæ¥ï¼Œå¼€å‘è€…åªéœ€ç»§æ‰¿AQSå¹¶å®ç°å°‘é‡æ–¹æ³•ï¼ˆå¦‚`tryAcquire`å’Œ`tryRelease`ï¼‰ï¼Œå³å¯åˆ›å»ºè‡ªå®šä¹‰çš„åŒæ­¥å·¥å…·ã€‚

AQSçš„æ ¸å¿ƒç»„ä»¶åŒ…æ‹¬ï¼š

- ä¸€ä¸ª`volatile int`ç±»å‹çš„`state`å˜é‡ï¼Œè¡¨ç¤ºåŒæ­¥çŠ¶æ€ã€‚
- ä¸€ä¸ªåŸºäºCLHï¼ˆCraig, Landin, and Hagerstenï¼‰é˜Ÿåˆ—çš„åŒå‘é“¾è¡¨ï¼Œç”¨äºç®¡ç†ç­‰å¾…çº¿ç¨‹ã€‚
- CASï¼ˆCompare-And-Swapï¼‰æ“ä½œå’Œçº¿ç¨‹çš„park/unparkæœºåˆ¶ï¼Œç”¨äºé«˜æ•ˆæ›´æ–°çŠ¶æ€å’Œè°ƒåº¦çº¿ç¨‹ã€‚

å½¢è±¡åœ°è¯´ï¼ŒAQSå°±åƒä¸€ä¸ªâ€œé”çš„å·¥å‚â€ï¼Œæä¾›äº†é”çš„éª¨æ¶å’Œæµæ°´çº¿ï¼Œå…·ä½“é”çš„ç‰¹æ€§ï¼ˆå¦‚å¯é‡å…¥æ€§ã€å…¬å¹³æ€§ï¼‰ç”±å­ç±»å†³å®šã€‚å¸¸è§çš„å¹¶å‘å·¥å…·å¦‚`ReentrantLock`ã€`Semaphore`ã€`CountDownLatch`å’Œ`ReentrantReadWriteLock`éƒ½åŸºäºAQSå®ç°ã€‚ç†è§£AQSä¸ä»…èƒ½å¸®åŠ©ä½ æŒæ¡è¿™äº›å·¥å…·çš„åº•å±‚åŸç†ï¼Œè¿˜èƒ½åœ¨é¢è¯•ä¸­å±•ç¤ºå¯¹å¹¶å‘å®‰å…¨çš„æ·±åˆ»ç†è§£ã€‚

***

### 2. ä¸»è¦ç‰¹ç‚¹ ğŸ“Œ

AQSä½œä¸ºJavaå¹¶å‘ç¼–ç¨‹çš„æ ¸å¿ƒç»„ä»¶ï¼Œå…·æœ‰ä»¥ä¸‹å‡ ä¸ªæ˜¾è‘—ç‰¹ç‚¹ï¼Œé¢è¯•ä¸­å¯ä»¥å¿«é€ŸæŠ“ä½è¿™äº›è¦ç‚¹å±•ç¤ºä¸“ä¸šæ€§ï¼š

- **é€šç”¨æ€§**ï¼šAQSæ”¯æŒç‹¬å æ¨¡å¼ï¼ˆå¦‚é”ï¼‰å’Œå…±äº«æ¨¡å¼ï¼ˆå¦‚ä¿¡å·é‡ï¼‰ï¼Œé€‚ç”¨äºå¤šç§åŒæ­¥åœºæ™¯ã€‚
- **é«˜æ•ˆæ€§**ï¼šåŸºäºCASå’Œpark/unparkæœºåˆ¶ï¼Œå‡å°‘çº¿ç¨‹åˆ‡æ¢å¼€é”€ï¼Œæå‡é«˜å¹¶å‘æ€§èƒ½ã€‚
- **çµæ´»æ€§**ï¼šæ”¯æŒä¸­æ–­ã€è¶…æ—¶å’Œå…¬å¹³æ€§é€‰æ‹©ï¼Œæ»¡è¶³å¤æ‚éœ€æ±‚ã€‚
- **å¯æ‰©å±•æ€§**ï¼šé€šè¿‡ç»§æ‰¿å’Œæ–¹æ³•é‡å†™ï¼Œå¼€å‘è€…å¯è½»æ¾å®ç°è‡ªå®šä¹‰åŒæ­¥å™¨ã€‚
- **çº¿ç¨‹å®‰å…¨**ï¼šä½¿ç”¨volatileå’ŒCASä¿è¯çŠ¶æ€æ›´æ–°çš„åŸå­æ€§å’Œå¯è§æ€§ã€‚

ä¸ºäº†æ›´ç›´è§‚åœ°å¯¹æ¯”AQSä¸ä¼ ç»Ÿ`synchronized`ï¼Œæˆ‘æ•´ç†äº†ä»¥ä¸‹è¡¨æ ¼ï¼š

| **ç‰¹æ€§**â€‹ | **AQS**â€‹    | **synchronized**â€‹ |
| ------- | ----------- | ----------------- |
| å®ç°æ–¹å¼    | åŸºäºCASå’Œé˜Ÿåˆ—çš„æ¡†æ¶ | åŸºäºMonitorçš„JVMå†…ç½®é”  |
| çµæ´»æ€§     | é«˜ï¼Œæ”¯æŒè‡ªå®šä¹‰é€»è¾‘   | ä½ï¼Œè¡Œä¸ºå›ºå®š            |
| æ€§èƒ½      | é«˜ï¼Œå‡å°‘é˜»å¡å¼€é”€    | æ—©æœŸé‡é‡çº§ï¼Œåä¼˜åŒ–         |
| ä¸­æ–­æ”¯æŒ    | æ”¯æŒ          | ä¸æ”¯æŒ               |
| è¶…æ—¶æ”¯æŒ    | æ”¯æŒ          | ä¸æ”¯æŒ               |
| å…¬å¹³æ€§     | å¯é€‰ï¼ˆå…¬å¹³/éå…¬å¹³ï¼‰  | éå…¬å¹³               |

**è¡¨æ ¼è¯´æ˜**ï¼šæ­¤è¡¨æ ¼å±•ç¤ºäº†AQSåœ¨çµæ´»æ€§å’Œæ€§èƒ½ä¸Šçš„ä¼˜åŠ¿ã€‚é¢è¯•ä¸­å¯ä»¥ç”¨å®ƒè¯´æ˜ï¼šâ€œAQSé€šè¿‡é˜Ÿåˆ—å’ŒCASå®ç°é«˜æ•ˆåŒæ­¥ï¼Œæ¯”synchronizedæ›´çµæ´»ï¼Œå°¤å…¶åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ€§èƒ½æ›´ä¼˜ã€‚â€

***

### 3. åº”ç”¨ç›®æ ‡ ğŸ¯

AQSåœ¨Javaå¹¶å‘ç¼–ç¨‹ä¸­çš„åº”ç”¨ç›®æ ‡æ˜ç¡®ï¼Œä»¥ä¸‹å‡ ç‚¹æ˜¯å…¶æ ¸å¿ƒä»·å€¼ï¼Œä¹Ÿæ˜¯é¢è¯•ä¸­å¸¸è¢«è€ƒå¯Ÿçš„é‡ç‚¹ï¼š

- **ç®€åŒ–åŒæ­¥å·¥å…·å¼€å‘**ï¼šæä¾›é€šç”¨æ¡†æ¶ï¼Œé™ä½å®ç°é”å’ŒåŒæ­¥å™¨çš„å¤æ‚åº¦ã€‚
- **æå‡å¹¶å‘æ€§èƒ½**ï¼šé€šè¿‡é«˜æ•ˆçš„çŠ¶æ€ç®¡ç†å’Œçº¿ç¨‹è°ƒåº¦ï¼Œå‡å°‘é”ç«äº‰å¼€é”€ã€‚
- **æ”¯æŒå¤šæ ·åŒ–åŒæ­¥æ¨¡å¼**ï¼šåŒ…æ‹¬ç‹¬å æ¨¡å¼ã€å…±äº«æ¨¡å¼å’Œæ¡ä»¶ç­‰å¾…ï¼Œé€‚åº”ä¸åŒåœºæ™¯ã€‚
- **å¢å¼ºçµæ´»æ€§**ï¼šæ”¯æŒä¸­æ–­ã€è¶…æ—¶å’Œå…¬å¹³æ€§é…ç½®ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚
- **ç»Ÿä¸€å¹¶å‘å·¥å…·å®ç°**ï¼šä¸ºJavaå¹¶å‘åŒ…ä¸­çš„å·¥å…·æä¾›ä¸€è‡´çš„åº•å±‚æ”¯æŒã€‚

**ç¤ºä¾‹**ï¼š`ReentrantLock`æ˜¯AQSçš„å…¸å‹åº”ç”¨ï¼Œæ”¯æŒå¯é‡å…¥é”ï¼š

```java 
import java.util.concurrent.locks.ReentrantLock;

public class ReentrantLockDemo {
    private final ReentrantLock lock = new ReentrantLock();

    public void method() {
        lock.lock();
        try {
            System.out.println("çº¿ç¨‹ " + Thread.currentThread().getName() + " è·å–é”");
        } finally {
            lock.unlock();
        }
    }
}
```


**è¯´æ˜**ï¼š`ReentrantLock`é€šè¿‡AQSçš„ç‹¬å æ¨¡å¼å®ç°é”çš„è·å–å’Œé‡Šæ”¾ï¼Œ`state`è®°å½•é‡å…¥æ¬¡æ•°ï¼Œæ”¯æŒçµæ´»çš„é”è¡Œä¸ºã€‚

***

### 4. ä¸»è¦å†…å®¹åŠå…¶ç»„æˆéƒ¨åˆ† ğŸ“š

AQSåŒ…å«å¤šä¸ªæ ¸å¿ƒç»„æˆéƒ¨åˆ†ï¼Œä»¥ä¸‹é€ä¸€å±•å¼€ï¼Œç¡®ä¿å†…å®¹è¯¦å°½ä¸”æ˜“äºèƒŒè¯µã€‚

#### 4.1 åŒæ­¥çŠ¶æ€ï¼ˆstateï¼‰

- **å®šä¹‰**ï¼šAQSç»´æŠ¤ä¸€ä¸ª`volatile int`ç±»å‹çš„`state`å˜é‡ï¼Œè¡¨ç¤ºåŒæ­¥çŠ¶æ€ã€‚
- **ä½œç”¨**ï¼š`state`çš„å«ä¹‰ç”±å­ç±»å®šä¹‰ã€‚ä¾‹å¦‚ï¼Œåœ¨`ReentrantLock`ä¸­ï¼Œ`state=0`è¡¨ç¤ºæ— é”ï¼Œ`state>0`è¡¨ç¤ºé”è¢«æŒæœ‰ä¸”è®°å½•é‡å…¥æ¬¡æ•°ï¼›åœ¨`Semaphore`ä¸­ï¼Œ`state`è¡¨ç¤ºå¯ç”¨è®¸å¯æ•°ã€‚
- **æ“ä½œ**ï¼šé€šè¿‡`getState()`ã€`setState()`å’Œ`compareAndSetState()`æ–¹æ³•è®¿é—®å’Œä¿®æ”¹ï¼ŒCASç¡®ä¿åŸå­æ€§ã€‚
- **è¡¥å……è¯´æ˜**ï¼š`volatile`ä¿è¯`state`çš„å¯è§æ€§ï¼Œçº¿ç¨‹ä¿®æ”¹åç«‹å³å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚

#### 4.2 ç­‰å¾…é˜Ÿåˆ—ï¼ˆCLHé˜Ÿåˆ—ï¼‰

- **å®šä¹‰**ï¼šAQSä½¿ç”¨ä¸€ä¸ªFIFOåŒå‘é“¾è¡¨ï¼ˆCLHé˜Ÿåˆ—ï¼‰ç®¡ç†ç­‰å¾…é”çš„çº¿ç¨‹ã€‚
- **èŠ‚ç‚¹ç»“æ„**ï¼šæ¯ä¸ªèŠ‚ç‚¹ï¼ˆ`Node`ï¼‰åŒ…å«ï¼š
  - `thread`ï¼šç­‰å¾…çš„çº¿ç¨‹å¼•ç”¨ã€‚
  - `prev`ï¼šå‰é©±èŠ‚ç‚¹ã€‚
  - `next`ï¼šåç»§èŠ‚ç‚¹ã€‚
  - `waitStatus`ï¼šç­‰å¾…çŠ¶æ€ï¼ˆå¦‚CANCELLEDã€SIGNALï¼‰ã€‚
- **å…¥é˜Ÿ**ï¼šçº¿ç¨‹è·å–é”å¤±è´¥æ—¶ï¼Œå°è£…ä¸ºNodeåŠ å…¥é˜Ÿåˆ—å°¾éƒ¨ã€‚
- **å‡ºé˜Ÿ**ï¼šé”é‡Šæ”¾æ—¶ï¼Œå”¤é†’é˜Ÿåˆ—å¤´éƒ¨çš„çº¿ç¨‹ã€‚

**é˜Ÿåˆ—ç»“æ„å›¾**ï¼š

```mermaid 
graph LR
    Head --> Node1[Thread A]
    Node1 --> Node2[Thread B]
    Node2 --> Tail
```


**å›¾è¡¨è¯´æ˜**ï¼šæ­¤å›¾å±•ç¤ºAQSç­‰å¾…é˜Ÿåˆ—çš„ç»“æ„ï¼ŒHeadå’ŒTailæ˜¯å“¨å…µèŠ‚ç‚¹ï¼ŒNode1å’ŒNode2æ˜¯ç­‰å¾…çº¿ç¨‹ã€‚é¢è¯•ä¸­å¯ä»¥ç”¨æ­¤å›¾è§£é‡Šçº¿ç¨‹å¦‚ä½•æ’é˜Ÿç­‰å¾…é”ã€‚

#### 4.3 ç‹¬å æ¨¡å¼ä¸å…±äº«æ¨¡å¼

- **ç‹¬å æ¨¡å¼**ï¼šä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å–é”ï¼Œå…¸å‹å®ç°å¦‚`ReentrantLock`ã€‚
  - `tryAcquire`ï¼šå°è¯•è·å–é”ã€‚
  - `tryRelease`ï¼šå°è¯•é‡Šæ”¾é”ã€‚
- **å…±äº«æ¨¡å¼**ï¼šå¤šä¸ªçº¿ç¨‹å¯åŒæ—¶è·å–é”ï¼Œå…¸å‹å®ç°å¦‚`Semaphore`ã€‚
  - `tryAcquireShared`ï¼šå°è¯•å…±äº«è·å–é”ã€‚
  - `tryReleaseShared`ï¼šå°è¯•å…±äº«é‡Šæ”¾é”ã€‚
- **å®ç°**ï¼šå­ç±»é‡å†™è¿™äº›æ–¹æ³•å®šä¹‰å…·ä½“é€»è¾‘ï¼ŒAQSè´Ÿè´£é˜Ÿåˆ—ç®¡ç†å’Œçº¿ç¨‹è°ƒåº¦ã€‚

**ç¤ºä¾‹**ï¼šè‡ªå®šä¹‰ç‹¬å é”ï¼š

```java 
public class SimpleLock extends AbstractQueuedSynchronizer {
    @Override
    protected boolean tryAcquire(int arg) {
        return compareAndSetState(0, 1);
    }

    @Override
    protected boolean tryRelease(int arg) {
        setState(0);
        return true;
    }

    public void lock() { acquire(1); }
    public void unlock() { release(1); }
}
```


**è¯´æ˜**ï¼š`state=0`è¡¨ç¤ºé”ç©ºé—²ï¼Œ`state=1`è¡¨ç¤ºé”è¢«æŒæœ‰ï¼ŒCASç¡®ä¿åŸå­æ€§ã€‚

#### 4.4 æ¡ä»¶é˜Ÿåˆ—ï¼ˆConditionï¼‰

- **å®šä¹‰**ï¼šAQSé€šè¿‡`ConditionObject`æ”¯æŒæ¡ä»¶ç­‰å¾…ã€‚
- **ä½œç”¨**ï¼šçº¿ç¨‹è·å–é”åå¯ç­‰å¾…ç‰¹å®šæ¡ä»¶ï¼Œå¦‚`await()`å’Œ`signal()`ã€‚
- **æµç¨‹**ï¼š
  1. `await()`ï¼šçº¿ç¨‹é‡Šæ”¾é”ï¼ŒåŠ å…¥æ¡ä»¶é˜Ÿåˆ—ï¼ŒçŠ¶æ€å˜ä¸ºWAITINGã€‚
  2. `signal()`ï¼šå°†æ¡ä»¶é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ç§»å›ç­‰å¾…é˜Ÿåˆ—ï¼Œç­‰å¾…é‡æ–°è·å–é”ã€‚
- **è¡¥å……è¯´æ˜**ï¼šæ¡ä»¶é˜Ÿåˆ—ä¸ç­‰å¾…é˜Ÿåˆ—åˆ†ç¦»ï¼Œæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ã€‚

**ç¤ºä¾‹**ï¼š

```java 
import java.util.concurrent.locks.*;

public class ConditionDemo {
    private final ReentrantLock lock = new ReentrantLock();
    private final Condition condition = lock.newCondition();

    public void await() throws InterruptedException {
        lock.lock();
        try {
            System.out.println("ç­‰å¾…æ¡ä»¶");
            condition.await();
        } finally {
            lock.unlock();
        }
    }

    public void signal() {
        lock.lock();
        try {
            System.out.println("å‘é€ä¿¡å·");
            condition.signal();
        } finally {
            lock.unlock();
        }
    }
}
```


**è¯´æ˜**ï¼š`Condition`æä¾›ç±»ä¼¼`wait()`å’Œ`notify()`çš„åä½œæœºåˆ¶ï¼Œä½†æ›´çµæ´»ã€‚

#### 4.5 æ ¸å¿ƒæ–¹æ³•

- **acquire(int arg)**ï¼šç‹¬å æ¨¡å¼è·å–é”ï¼Œå¤±è´¥åˆ™å…¥é˜Ÿç­‰å¾…ã€‚
- **release(int arg)**ï¼šç‹¬å æ¨¡å¼é‡Šæ”¾é”ï¼Œå”¤é†’é˜Ÿåˆ—å¤´éƒ¨çº¿ç¨‹ã€‚
- **acquireShared(int arg)**ï¼šå…±äº«æ¨¡å¼è·å–é”ã€‚
- **releaseShared(int arg)**ï¼šå…±äº«æ¨¡å¼é‡Šæ”¾é”ã€‚
- **tryAcquire(int arg)**ï¼šå­ç±»å®ç°çš„ç‹¬å è·å–é€»è¾‘ã€‚
- **tryRelease(int arg)**ï¼šå­ç±»å®ç°çš„ç‹¬å é‡Šæ”¾é€»è¾‘ã€‚

***

### 5. åŸç†å‰–æ ğŸ”

#### 5.1 åŒæ­¥çŠ¶æ€çš„åŸå­æ€§

AQSé€šè¿‡`Unsafe`ç±»çš„CASæ“ä½œï¼ˆå¦‚`compareAndSetState`ï¼‰æ›´æ–°`state`ï¼Œç¡®ä¿å¤šçº¿ç¨‹ä¸‹çš„åŸå­æ€§ã€‚CASæ˜¯ä¹è§‚é”çš„æ ¸å¿ƒï¼ŒåŸºäºç¡¬ä»¶æŒ‡ä»¤ï¼ˆcmpxchgï¼‰å®ç°ï¼Œé¿å…ä¼ ç»Ÿé”çš„å¼€é”€ã€‚

#### 5.2 ç­‰å¾…é˜Ÿåˆ—çš„å®ç°

- **å…¥é˜Ÿæµç¨‹**ï¼š
  1. åˆ›å»ºNodeèŠ‚ç‚¹ï¼Œå°è£…å½“å‰çº¿ç¨‹ã€‚
  2. ä½¿ç”¨CASå°†NodeåŠ å…¥é˜Ÿåˆ—å°¾éƒ¨ï¼ˆtailï¼‰ã€‚
  3. è‹¥å¤±è´¥ï¼Œè‡ªæ—‹é‡è¯•ã€‚
- **å‡ºé˜Ÿæµç¨‹**ï¼š
  1. é”é‡Šæ”¾æ—¶ï¼Œæ£€æŸ¥é˜Ÿåˆ—å¤´éƒ¨èŠ‚ç‚¹ã€‚
  2. è°ƒç”¨`LockSupport.unpark()`å”¤é†’çº¿ç¨‹ã€‚
- **çº¿ç¨‹çŠ¶æ€**ï¼š
  - `CANCELLED`ï¼šçº¿ç¨‹å–æ¶ˆã€‚
  - `SIGNAL`ï¼šç­‰å¾…å”¤é†’ã€‚
  - `CONDITION`ï¼šåœ¨æ¡ä»¶é˜Ÿåˆ—ä¸­ã€‚

#### 5.3 park/unparkæœºåˆ¶

- **park()**ï¼š`LockSupport.park()`æŒ‚èµ·çº¿ç¨‹ï¼Œåº•å±‚è°ƒç”¨æ“ä½œç³»ç»ŸåŸè¯­ï¼ˆå¦‚pthread\_cond\_waitï¼‰ã€‚
- **unpark()**ï¼š`LockSupport.unpark()`å”¤é†’çº¿ç¨‹ï¼Œæ¯”`synchronized`çš„Monitoræ›´è½»é‡ã€‚
- **ä¼˜åŠ¿**ï¼šæ”¯æŒç²¾ç¡®å”¤é†’ç‰¹å®šçº¿ç¨‹ï¼Œé¿å…`synchronized`ä¸­`notify()`çš„éšæœºæ€§ã€‚

#### 5.4 ç‹¬å ä¸å…±äº«æ¨¡å¼çš„åŒºåˆ«

- **ç‹¬å æ¨¡å¼**ï¼š`state`ä»0å˜ä¸º1ï¼Œæ ‡è®°é”è¢«å ç”¨ã€‚
- **å…±äº«æ¨¡å¼**ï¼š`state`è¡¨ç¤ºå¯ç”¨èµ„æºæ•°ï¼Œå…è®¸å¤šçº¿ç¨‹åŒæ—¶æŒæœ‰ã€‚

**çŠ¶æ€è½¬æ¢å›¾**ï¼š

```mermaid 
stateDiagram-v2
    [*] --> TryAcquire : å°è¯•è·å–é”
    TryAcquire --> Running : è·å–æˆåŠŸ
    TryAcquire --> Queued : è·å–å¤±è´¥
    Queued --> Blocked : park()
    Blocked --> TryAcquire : unpark()
    Running --> Released : release()
    Released --> [*]
```


**å›¾è¡¨è¯´æ˜**ï¼šæ­¤å›¾å±•ç¤ºçº¿ç¨‹åœ¨AQSä¸­è·å–å’Œé‡Šæ”¾é”çš„çŠ¶æ€è½¬æ¢ã€‚é¢è¯•ä¸­å¯ä»¥ç”¨å®ƒè§£é‡Šçº¿ç¨‹å¦‚ä½•æ’é˜Ÿå’Œå”¤é†’ã€‚

***

### 6. åº”ç”¨ä¸æ‹“å±• ğŸŒ

- **ReentrantLock**ï¼šå¯é‡å…¥é”ï¼Œæ”¯æŒå…¬å¹³æ€§å’Œéå…¬å¹³æ€§ã€‚
- **Semaphore**ï¼šä¿¡å·é‡ï¼Œæ§åˆ¶å¹¶å‘è®¿é—®èµ„æºã€‚
- **CountDownLatch**ï¼šå€’è®¡æ•°å™¨ï¼Œç­‰å¾…å¤šçº¿ç¨‹å®Œæˆã€‚
- **çº¿ç¨‹æ± **ï¼š`ThreadPoolExecutor`ä½¿ç”¨AQSç®¡ç†å·¥ä½œçº¿ç¨‹çŠ¶æ€ã€‚

**ç¤ºä¾‹**ï¼šè‡ªå®šä¹‰è®¡æ•°å™¨ï¼š

```java 
public class CustomLatch extends AbstractQueuedSynchronizer {
    public CustomLatch(int count) {
        setState(count);
    }

    @Override
    protected int tryAcquireShared(int arg) {
        return getState() == 0 ? 1 : -1;
    }

    @Override
    protected boolean tryReleaseShared(int arg) {
        for (;;) {
            int state = getState();
            if (state == 0) return false;
            if (compareAndSetState(state, state - 1)) return true;
        }
    }

    public void countDown() { releaseShared(1); }
    public void await() throws InterruptedException { acquireSharedInterruptibly(1); }
}
```


**è¯´æ˜**ï¼šæ­¤è®¡æ•°å™¨ç±»ä¼¼`CountDownLatch`ï¼Œ`state`å‡åˆ°0æ—¶å”¤é†’ç­‰å¾…çº¿ç¨‹ã€‚


