# 二. 业务相关

# A. 限流

## Nginx限流(漏桶算法)

- 控制速率(突发流量): 漏桶存储请求, 并以一定速率流出请求, 请求过多无法保存或等待或抛弃.
- 控制并发连接数

## 网关限流(令牌桶算法)

**RequestRateLimiter**: &#x20;

使用令牌桶算法进行限流, 以固定速率生成令牌并存入令牌桶中, 桶满暂停生成. 请求需要到令牌桶中申请令牌通申请到令牌的请求会被处理, 没有令牌的请求会被阻塞或丢弃.

# B. 分布式事务

## CAP

1. AP: 高可用, 不保证数据的强一致性.
2. CP: 保证访问数据的强一致性, 无法保证高可用.

#### Consistency: 一致性

分布式系统中的任意节点, 数据必须一致.

#### Availability: 可用性

用户访问集群中的任意健康节点, 必须能得到响应, 而不是超时或拒绝.;

#### Partition tolerance: 分区容错性

因网络故障或其他原因, 分布式系统中的部分节点与其他节点失去连接, 形成独立分区. 在集群出现分区时, 整个系统也能持续对外提供服务.

## BASE

对CAP的解决思路:

1. Basically Available: 基本可用, 分布式系统在出现故障时, 允许损失部分可用性, 既保证核心可用.
2. Soft State: 软状态, 在一定时间内, 允许出现中间状态, 比如临时的不一致状态.
3. Eventually Consistent: 最终一致性, 无法保证强一致性, 在软状态结束后, 最终达到数据一致性.

## Seata

Seata事务角色:

1. TC(Transaction Coordinator): 事务协调者, 维护全局和分支事务的状态, 协调全局事务的提交或回滚.
2. TM(Transaction Manager): 事务管理器, 定义全局事务的范围, 开始全局事务,提交或回滚全局事务.
3. RM(Resource Manager): 资源管理者, 管理分支事务处理的资源, 与TC沟通以注册分支事务和报告分支事务的状态, 并驱动分支事务提交或回滚.

#### XA

CP, 需要等待各个分支事务提交, 可以保证强一致性, 性能差, 适合银行业务.

#### AT

AP, 底层使用undo log实现,性能好, 适合互联网业务.

#### TCC

AP, 性能较好, 需要人工编码, 适合银行业务.

# C. 接口性幂等

多次调用方法或者接口不会改变业务主状态, 可以保证重复调用的结果和单词调用的结果一致. &#x20;

- GET: 查询操作天然幂等.
- POST: 新增操作, 请求操作与请求多次造成的结果不同, 不是幂等的.
- PUT: 更新操作, 以绝对值更新是幂等的, 以增量方式更新则不是幂等的.
- DELETE: 删除操作, 根据唯一值删除, 是幂等的.

## 数据库唯一索引

## token + redis

## 分布式锁

# D. 任务调度

xxljob:

- 路由策略:  轮询, 故障转移, 分片广播.
- 任务执行失败: 路由策略选择故障转移, 选择健康的实例来执行人物. 设置重试次数, 查看日志+邮件告警通知相关负责人解决.
- 大数据量的任务同时执行: 部署集群, 路由策略选用分片广播.

[1. 限流](<1. 限流/1. 限流.md> "1. 限流")

[2. 分布式事务](<2. 分布式事务/2. 分布式事务.md> "2. 分布式事务")

[3. 接口幂等](<3. 接口幂等/3. 接口幂等.md> "3. 接口幂等")

[4. 任务调度](<4. 任务调度/4. 任务调度.md> "4. 任务调度")
